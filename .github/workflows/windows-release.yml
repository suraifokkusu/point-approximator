name: Windows Build and Release

on:
  push:
    tags:
      - "v*" # Запуск Workflow при пуше нового тега с версией (например, v1.0.0)

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install MinGW
        run: |
          choco install mingw -y
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH

      - name: Install CMake
        run: |
          choco install cmake --version 3.31.1 -y
          echo "C:\Program Files\CMake\bin" >> $GITHUB_PATH

      - name: Verify Tools
        run: |
          g++ --version
          cmake --version

      - name: Configure CMake
        run: |
          cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release

      - name: Build with CMake
        run: |
          cmake --build build --config Release

      - name: Copy DLL dependencies
        run: |
            MINGW_PATH="C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin"
            TARGET_DIR="build/bin"
            cp $MINGW_PATH/libgcc_s_seh-1.dll $TARGET_DIR
            cp $MINGW_PATH/libstdc++-6.dll $TARGET_DIR
            cp $MINGW_PATH/libwinpthread-1.dll $TARGET_DIR || echo "libwinpthread-1.dll не используется"
    

      - name: Archive build artifacts
        run: |
          mkdir -p release
          cp build/bin/*.exe release/

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/
          asset_name: release.zip
          asset_content_type: application/zip
